{% load static %} <!-- new -->

<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <title>Django + Stripe Subscriptions</title>
    <script src="https://js.stripe.com/v3/"></script>
    <script src="https://code.jquery.com/jquery-3.5.1.min.js" integrity="sha256-9/aliU8dGd2tb6OSsuzixeV4y/faTqgFtohetphbbj0=" crossorigin="anonymous"></script>
    <link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/bootstrap/4.5.2/css/bootstrap.min.css" integrity="sha384-JcKb8q3iqJ61gNV9KGb8thSsNjpSL0n8PARn9HuZOnIxN0hoP+VmmDGMN5t9UJ0Z" crossorigin="anonymous">
    <script src="https://stackpath.bootstrapcdn.com/bootstrap/4.5.2/js/bootstrap.min.js" integrity="sha384-B4gt1jrGC7Jh4AgTPSdUtOBvfO8shuf57BaghqFfPlYxofvL8/KUEfYiJOMMV+rV" crossorigin="anonymous"></script>
  </head>
  <body>
    <table id="equity_etf_table" class="table table-dark table-hover table-striped table-bordered table-sm">
      <thead>
        <tr>
        <th data-sortable="true">Subscription Type</th>
        <th>Price</th>
        <th>Currency</th>
        <th>Button</th>
        </tr>
      </thead>
      <tbody>
        <tr>
          <td>Semiannual</td>
          <td>{{ semiannual_subscription.price }}</td>
          <td>{{ semiannual_subscription.Currency }}</td>
          <td>
            <button type="submit" class="btn btn-primary" id="submitBtn1">Subscribe</button>
          </td>
        </tr>
        <tr>
          <td>Monthly</td>
          <td>{{ monthly_subscription.price }}</td>
          <td>{{ monthly_subscription.Currency }}</td>
          <td>
            <button type="submit" class="btn btn-primary" id="submitBtn2">Subscribe</button>
          </td>
        </tr>
        <tr>
          <td>Annual</td>
          <td>{{ annual_subscription.price }}</td>
          <td>{{ annual_subscription.Currency }}</td>
          <td>
            <button type="submit" class="btn btn-primary" id="submitBtn3">Subscribe</button>
          </td>
        </tr>
      </tbody>
    </table>
  </body>
</html>

<script>
    fetch("{% url 'forecast:stripe-config' %}")
        .then((result) => { return result.json(); })
        .then((data) => {
        // Initialize Stripe.js
        const stripe = Stripe(data.publicKey);

        // new
        // Event handler
        let submitBtn1 = document.querySelector("#submitBtn1");
        let submitBtn2 = document.querySelector("#submitBtn2");
        let submitBtn3 = document.querySelector("#submitBtn3");

        if (submitBtn1 !== null || submitBtn2 !== null || submitBtn3 !== null) {
            submitBtn1.addEventListener("click", () => {
                // Get Checkout Session ID
                fetch("{% url 'forecast:stripe-session-creation' %}", {
                  method: "POST",
                  body: JSON.stringify({
                    subscription_type: "semiannual_subscription"
                  })
                })
                .then((result) => { return result.json(); })
                .then((data) => {
                    console.log(data);
                    // Redirect to Stripe Checkout
                    return stripe.redirectToCheckout({sessionId: data.sessionId})
                })
                .then((res) => {
                    console.log(res);
                });
            });
            submitBtn2.addEventListener("click", () => {
                // Get Checkout Session ID
                fetch("{% url 'forecast:stripe-session-creation' %}", {
                  method: "POST",
                  body: JSON.stringify({
                    subscription_type: "monthly_subscription"
                  })
                })
                .then((result) => { return result.json(); })
                .then((data) => {
                    console.log(data);
                    // Redirect to Stripe Checkout
                    return stripe.redirectToCheckout({sessionId: data.sessionId})
                })
                .then((res) => {
                    console.log(res);
                });
            });
            submitBtn3.addEventListener("click", () => {
                // Get Checkout Session ID
                fetch("{% url 'forecast:stripe-session-creation' %}", {
                  method: "POST",
                  body: JSON.stringify({
                    subscription_type: "annual_subscription"
                  })
                })
                .then((result) => { return result.json(); })
                .then((data) => {
                    console.log(data);
                    // Redirect to Stripe Checkout
                    return stripe.redirectToCheckout({sessionId: data.sessionId})
                })
                .then((res) => {
                    console.log(res);
                });
            });
        }
        });
</script>